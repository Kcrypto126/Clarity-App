# Clarity App - Supabase Schema Design

This document outlines the database schema for user-generated content and data in the Clarity app, which will be stored in Supabase.

## Database Tables

### Users

Table: `users`

Stores user authentication data and profile information.

| Column               | Type      | Description                                  |
| -------------------- | --------- | -------------------------------------------- |
| id                   | uuid      | Primary key, auto-generated by Supabase Auth |
| email                | text      | User's email address                         |
| created_at           | timestamp | When the user registered                     |
| updated_at           | timestamp | When user data was last updated              |
| first_name           | text      | User's first name                            |
| last_name            | text      | User's last name                             |
| age                  | integer   | User's age                                   |
| gender               | text      | User's gender identity                       |
| life_stage           | text      | User's current life stage                    |
| onboarding_completed | boolean   | Whether user has completed onboarding        |
| settings             | jsonb     | User settings and preferences                |

### User Node States

Table: `user_node_states`

Tracks the state of each node for each user (locked, unlocked, completed).

| Column              | Type      | Description                                         |
| ------------------- | --------- | --------------------------------------------------- |
| id                  | uuid      | Primary key                                         |
| user_id             | uuid      | Foreign key to users.id                             |
| node_id             | text      | ID of the node in Sanity                            |
| status              | text      | 'locked', 'unlocked', 'in-progress', or 'completed' |
| unlocked_at         | timestamp | When the node was unlocked                          |
| completed_at        | timestamp | When the node was completed                         |
| progress_percentage | integer   | Percentage completion (0-100)                       |
| user_notes          | text      | User's notes about this node                        |

### User Responses

Table: `user_responses`

Stores user answers to questions.

| Column           | Type      | Description                                                |
| ---------------- | --------- | ---------------------------------------------------------- |
| id               | uuid      | Primary key                                                |
| user_id          | uuid      | Foreign key to users.id                                    |
| node_id          | text      | ID of the node in Sanity                                   |
| question_id      | text      | ID of the question in Sanity                               |
| answer           | text      | User's answer to the question                              |
| created_at       | timestamp | When the response was created                              |
| updated_at       | timestamp | When the response was last updated                         |
| journal_entry_id | uuid      | Foreign key to journal_entries.id (if answer is a journal) |
| skipped          | boolean   | Whether the question was skipped                           |
| skip_reason      | text      | Reason for skipping (if applicable)                        |

### Journal Entries

Table: `journal_entries`

Stores user's journal entries.

| Column               | Type      | Description                               |
| -------------------- | --------- | ----------------------------------------- |
| id                   | uuid      | Primary key                               |
| user_id              | uuid      | Foreign key to users.id                   |
| title                | text      | Optional title of the journal entry       |
| content              | text      | Content of the journal entry              |
| created_at           | timestamp | When the entry was created                |
| updated_at           | timestamp | When the entry was last updated           |
| related_node_ids     | text[]    | Array of related node IDs from Sanity     |
| related_question_ids | text[]    | Array of related question IDs from Sanity |
| tags                 | text[]    | User or AI-generated tags                 |
| mood                 | text      | User's mood when writing the entry        |
| ai_summary           | text      | AI-generated summary of the entry         |
| ai_tags              | text[]    | AI-generated tags                         |

### User Intro Assessment

Table: `user_intro_assessments`

Stores the user's responses to the introductory assessment.

| Column             | Type      | Description                              |
| ------------------ | --------- | ---------------------------------------- |
| id                 | uuid      | Primary key                              |
| user_id            | uuid      | Foreign key to users.id                  |
| completed_at       | timestamp | When the assessment was completed        |
| assessment_version | text      | Version of the assessment taken          |
| unlocked_nodes     | text[]    | Array of node IDs unlocked by assessment |

## Relationships and Indexes

### Foreign Key Constraints

- `user_node_states.user_id` references `users.id`
- `user_responses.user_id` references `users.id`
- `journal_entries.user_id` references `users.id`
- `user_responses.journal_entry_id` references `journal_entries.id`
- `user_intro_assessments.user_id` references `users.id`

### Indexes

- `user_node_states`: (user_id, node_id)
- `user_responses`: (user_id, node_id, question_id)
- `journal_entries`: (user_id, created_at)
- `user_intro_assessments`: (user_id)

## Row-Level Security Policies

All tables will have row-level security enabled with policies that ensure users can only access their own data:

```sql
-- Example policy for user_node_states
CREATE POLICY "Users can only access their own node states"
  ON user_node_states
  FOR ALL
  USING (auth.uid() = user_id);
```

Similar policies will be created for all user data tables.

## Real-time Subscriptions

The following table will be enabled for real-time subscriptions to support immediate UI updates:

- `user_node_states` - For updating the mind map as users progress

## Vector Search Integration

For implementing vector similarity searches:

- We'll generate and store embeddings of nodes and user content
- Supabase's pgvector extension will be used for vector similarity searches
- This will enable "related nodes" functionality based on user responses and journal entries

## Migration Strategy

1. Create tables in Supabase
2. Set up row-level security policies
3. Configure real-time subscriptions
4. Create initial indexes
5. Test with sample data before production
